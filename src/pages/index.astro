---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getEntry, getCollection } from 'astro:content';

// ì½˜í…ì¸  ì»¬ë ‰ì…˜ì—ì„œ ë°ì´í„° ë¡œë“œ
const profileEntry = await getEntry('profile', 'jylee');
const profile = profileEntry?.data;
const pageTitle = profile ? `${profile.name} | ${profile.title}` : 'ì´ë ¥ì„œ';

const workEntries = await getCollection('work', ({ data }) => data.visible);
const work = workEntries
  .sort((a, b) => a.data.order - b.data.order)
  .map((entry) => entry.data);

const educationEntries = await getCollection('education', ({ data }) => data.visible);
const education = educationEntries
  .sort((a, b) => a.data.order - b.data.order)
  .map((entry) => entry.data);

const certEntries = await getCollection('certifications', ({ data }) => data.visible);
const certs = certEntries
  .sort((a, b) => a.data.order - b.data.order)
  .map((entry) => entry.data);

const projectEntries = await getCollection('projects', ({ data }) => data.visible);
const projects = await Promise.all(
  projectEntries
    .sort((a, b) => a.data.order - b.data.order)
    .map(async (entry) => {
      const rendered = await entry.render();
      return { ...entry.data, Content: rendered.Content };
    })
);
---

<BaseLayout pageTitle={pageTitle}>
  <!-- 1. í”„ë¡œí•„ ìš”ì•½ -->
  <section class="mb-16 scroll-mt-24" id="abstract">
    <h2>Abstract</h2>
    <div class="flex flex-col gap-4 sm:flex-row sm:gap-8 items-start">
      <img
        src={profile?.photo || '/assets/profile.jpg'}
        alt={profile?.name ?? 'í”„ë¡œí•„ ì‚¬ì§„'}
        class="w-[100px] h-[125px] sm:w-[120px] sm:h-[150px] object-cover border border-border rounded-sm flex-shrink-0 grayscale"
      />
      <div class="flex-1">
        <p class="mt-0 text-lg leading-relaxed whitespace-pre-line max-w-none">
          {profile?.summary}
        </p>
        <div class="mt-4 text-sm text-muted">
          <span class="font-semibold text-heading">Area:</span>
          <span class="ml-2">{profile?.area?.join(', ')}</span>
        </div>
        <div class="mt-2 flex flex-wrap gap-4 text-sm text-muted">
          {profile?.email && <span>ðŸ“§ {profile.email}</span>}
          {profile?.phone && <span>ðŸ“ž {profile.phone}</span>}
        </div>
      </div>
    </div>
  </section>

  <!-- 2. ê²½ë ¥ -->
  {work.length > 0 && (
    <section class="mb-16 scroll-mt-24" id="work">
      <h2>Work Experience</h2>
      <div class="border-l-2 border-border pl-6 ml-2">
        {work.map((item) => (
          <div class="relative mb-8">
            <span
              aria-hidden="true"
              class="absolute -left-[1.05rem] top-2 size-3 rounded-full border-2 border-link bg-paper"
            />
            <div class="flex flex-wrap items-baseline justify-between gap-4">
              <h3 class="m-0 text-lg font-bold text-heading">{item.company}</h3>
              <span class="text-sm text-muted font-mono">
                {item.start_date.toISOString().split('T')[0]} ~{' '}
                {item.is_current ? 'Present' : item.end_date?.toISOString().split('T')[0]}
              </span>
            </div>
            <div class="mt-1 text-sm text-ink">
              <span class="font-semibold">{item.position}</span>
              {item.department && <span class="ml-2 text-muted">| {item.department}</span>}
            </div>
            {item.description && (
              <p class="mt-3 text-sm text-muted whitespace-pre-line leading-relaxed max-w-none">
                {item.description}
              </p>
            )}
            {item.achievements && item.achievements.length > 0 && (
              <ul class="mt-3 list-disc pl-5 space-y-1 text-sm max-w-none">
                {item.achievements.map((ach) => (
                  <li>{ach}</li>
                ))}
              </ul>
            )}
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- 3. í”„ë¡œì íŠ¸ -->
  {projects.length > 0 && (
    <section class="mb-16 scroll-mt-24" id="projects">
      <h2>Projects & Case Studies</h2>
      {projects.map((project) => (
        <article class="mb-12 pb-8 border-b border-dashed border-border last:border-b-0">
          <header class="flex flex-wrap items-baseline justify-between gap-3">
            <h3 class="m-0 text-xl font-bold text-heading">{project.title}</h3>
            <div class="flex flex-wrap items-center gap-4">
              <span class="text-sm font-mono text-teal">{project.category}</span>
              {project.github_url && (
                <a href={project.github_url} class="text-sm border-0 hover:underline" target="_blank">
                  GitHub
                </a>
              )}
              {project.demo_url && (
                <a href={project.demo_url} class="text-sm border-0 hover:underline" target="_blank">
                  Demo
                </a>
              )}
            </div>
          </header>

          <div class="mt-4 prose prose-slate max-w-none">
            <project.Content />
          </div>

          <ul class="mt-6 list-none p-0 m-0 flex flex-wrap gap-2 font-mono text-sm">
            {project.tech_stack?.map((tech) => (
              <li class="text-muted bg-code px-2 py-0.5 rounded">{tech}</li>
            ))}
          </ul>
        </article>
      ))}
    </section>
  )}

  <!-- 4. í•™ë ¥ -->
  {education.length > 0 && (
    <section class="mb-16 scroll-mt-24" id="education">
      <h2>Education</h2>
      <div class="border-l-2 border-border pl-6 ml-2">
        {education.map((edu) => (
          <div class="relative mb-8">
            <span
              aria-hidden="true"
              class="absolute -left-[1.05rem] top-2 size-3 rounded-full border-2 border-link bg-paper"
            />
            <div class="flex flex-wrap items-baseline justify-between gap-4">
              <h3 class="m-0 text-lg font-bold text-heading">{edu.school}</h3>
              <span class="text-sm text-muted font-mono">
                {edu.start_date.toISOString().split('T')[0]} ~{' '}
                {edu.end_date ? edu.end_date.toISOString().split('T')[0] : 'Present'}
              </span>
            </div>
            <div class="mt-1 text-sm text-ink">
              <span class="font-semibold">{edu.major}</span>
              <span class="ml-2 text-muted">
                | {edu.degree} ({edu.status})
              </span>
              {edu.gpa && <span class="ml-2 text-muted">(GPA: {edu.gpa})</span>}
            </div>
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- 5. ìžê²©/ìˆ˜ìƒ -->
  {certs.length > 0 && (
    <section class="mb-16 scroll-mt-24" id="certs">
      <h2>Certifications & Awards</h2>
      <ul class="list-none p-0 m-0 space-y-2">
        {certs.map((cert) => (
          <li class="text-sm">
            <span class="font-mono text-muted mr-3">{cert.date.toISOString().split('T')[0]}</span>
            <strong class="text-heading">{cert.name}</strong>
            <span class="text-ink"> - {cert.issuer}</span>
            {cert.score && <span class="text-muted ml-2">({cert.score})</span>}
          </li>
        ))}
      </ul>
    </section>
  )}

  <!-- 6. ê¸°ìˆ  ìŠ¤íƒ -->
  <section class="mb-16 scroll-mt-24" id="stack">
    <h2>Technical Stack</h2>
    <table>
      <tbody>
        <tr>
          <th>Embedded</th>
          <td class="font-mono">C, C++, STM32, HAL, FreeRTOS, UART/I2C/SPI</td>
        </tr>
        <tr>
          <th>AI & Data</th>
          <td class="font-mono">Python, PyTorch, TensorFlow, OpenCV, LLM (RAG/LoRA)</td>
        </tr>
        <tr>
          <th>Backend</th>
          <td class="font-mono">Django, Docker, PostgreSQL, AWS EC2, Git</td>
        </tr>
      </tbody>
    </table>
  </section>
</BaseLayout>

